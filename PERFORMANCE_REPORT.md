# FastFile 性能评估报告

## 📊 压缩性能测试结果

### 测试环境
- 库: fflate
- 压缩级别: 6 (默认)
- 数据类型: 随机数据（模拟真实文件）

### 实测数据

| 文件大小 | 墙钟时间 | CPU时间 | 压缩速度(CPU) | 压缩率 |
|---------|---------|---------|--------------|--------|
| 1 MB    | 20ms    | 32ms    | 31.23 MB/s   | -0.03% |
| 10 MB   | 139ms   | 151ms   | 66.16 MB/s   | -0.02% |
| 50 MB   | 663ms   | 672ms   | 74.38 MB/s   | -0.02% |
| 100 MB  | 1344ms  | 1355ms  | 73.79 MB/s   | -0.02% |

**平均压缩速度**: ~73.79 MB/s (CPU时间)

**注意**: 压缩率为负值是因为测试使用随机数据，随机数据无法压缩反而会略微增大（zip文件头开销）。真实文件通常能获得30-70%的压缩率。

## ⏱️ 10GB 文件压缩时间估算

### 基于实测数据估算

**文件大小**: 10GB (10,240 MB)
**估算CPU时间**: **138.78 秒** ≈ **2.31 分钟**
**估算墙钟时间**: 152.66 秒 ≈ 2.54 分钟

### 不同压缩级别的时间预估

| 压缩级别 | 描述 | 预计时间 | 是否可行 |
|---------|------|---------|---------|
| 0 | 无压缩(仅打包) | ~14秒 (0.2分钟) | ✅ |
| 1 | 最快压缩 | ~46秒 (0.8分钟) | ✅ |
| 3 | 快速压缩 | ~69秒 (1.2分钟) | ✅ |
| 6 | 默认压缩 | ~139秒 (2.3分钟) | ✅ |
| 9 | 最大压缩 | ~278秒 (4.6分钟) | ✅ |

## 🚦 Cloudflare Workers CPU 限制分析

### CPU 时间限制

- **默认限制**: 30秒 (30,000ms)
- **最大限制**: 5分钟 (300秒 / 300,000ms)
- **Cron任务**:
  - 间隔 < 1小时: 30秒
  - 间隔 ≥ 1小时: 15分钟

### 10GB 文件处理结论

⚠️ **10GB 文件压缩需要约 2.3 分钟**，超出默认30秒限制，但**在最大5分钟限制内**。

## ✅ 建议配置

### 1. 增加 CPU 时间限制

在 `wrangler.toml` 中添加：

```toml
# 设置CPU时间限制为 3分钟（留有余量）
limits = { cpu_ms = 180000 }
```

或者根据实际需求调整：

```toml
# 保守配置（推荐）: 150秒 = 2.5分钟
limits = { cpu_ms = 150000 }

# 激进配置: 使用最大值 5分钟
limits = { cpu_ms = 300000 }
```

### 2. 降低压缩级别

如果担心超时，可以降低压缩级别：

**修改 `src/index.js:310`:**

```javascript
// 原代码
const zipped = zipSync(filesToZip, {
  level: 6, // 压缩级别 0-9
});

// 建议改为
const zipped = zipSync(filesToZip, {
  level: 3, // 快速压缩，10GB约1.2分钟
});
```

**压缩级别对比**:
- `level: 1` - 最快，10GB约46秒，压缩率较低
- `level: 3` - 快速，10GB约69秒，压缩率适中 ✅ **推荐**
- `level: 6` - 默认，10GB约139秒，压缩率较好
- `level: 9` - 最大，10GB约278秒，压缩率最好但耗时长

### 3. 限制文件大小

根据实际需求调整最大文件限制：

| 最大文件大小 | CPU时间(level 3) | CPU时间(level 6) | 建议 |
|------------|-----------------|-----------------|------|
| 1GB | ~7秒 | ~14秒 | ✅ 默认限制内 |
| 5GB | ~34秒 | ~69秒 | ⚠️ 需配置CPU限制 |
| 10GB | ~69秒 | ~139秒 | ⚠️ 需配置CPU限制 |

**修改 `src/index.js:123`:**

```javascript
// 根据需求调整大小限制
if (fileSize > 5 * 1024 * 1024 * 1024) {  // 改为5GB
  return errorResponse('文件大小超过5GB限制');
}
```

## 🔧 优化方案

### 方案1: 流式压缩（推荐）

使用 `fflate` 的异步流式API，分块处理：

```javascript
import { AsyncZipDeflate, Zip } from 'fflate';

// 流式压缩，不会一次性占用大量内存
const zip = new Zip();
// ... 添加文件流
```

**优势**:
- 降低内存占用
- 更好的进度追踪
- 可以中断和恢复

### 方案2: 使用 Durable Objects

对于超大文件或长时间压缩：

```javascript
// 在 Durable Object 中执行压缩
// Durable Objects 有更长的CPU时间限制
```

**优势**:
- 支持更长的执行时间
- 状态持久化
- 支持并发处理

### 方案3: 分块上传+压缩

将大文件分成多个小块：

```javascript
// 客户端分块上传
// 服务器端分别压缩后合并
```

**优势**:
- 避免单次超时
- 支持断点续传
- 更好的错误恢复

## 📈 其他限制考量

### 1. 内存限制

Workers 内存限制：**128MB**

**10GB文件内存使用估算**:
- 读取文件: 全部加载到内存需要10GB（会超限）
- **当前实现**: 逐个文件读取，单个文件占用内存

**建议**:
- 限制单个文件大小不超过100MB
- 或实现流式处理

### 2. R2 操作限制

- **读取速度**: 通常 > 100 MB/s
- **写入速度**: 通常 > 50 MB/s
- **对象大小**: 最大5TB

### 3. KV 限制

- **值大小**: 最大25MB（足够存储元数据）
- **写入速率**: 每秒1000次

## 🎯 最终建议

### 生产环境配置

1. **CPU限制**: 设置为 `150000ms` (2.5分钟)
2. **压缩级别**: 使用 `level: 3`
3. **文件大小限制**:
   - 保守: 5GB
   - 激进: 10GB
4. **实现流式压缩**（可选，长期优化）

### wrangler.toml 配置示例

```toml
name = "fastfile"
main = "src/index.js"
compatibility_date = "2024-01-01"

# CPU时间限制: 2.5分钟
limits = { cpu_ms = 150000 }

[[kv_namespaces]]
binding = "FILE_META"
id = "eebe6705cd794ffea868aeea3954658c"

[[r2_buckets]]
binding = "FILE_STORAGE"
bucket_name = "fastfile-storage"

[triggers]
crons = ["0 0 * * *"]

routes = [
  { pattern = "file.zwi.monster/*", zone_name = "zwi.monster" }
]
```

### src/index.js 优化建议

```javascript
// 使用快速压缩级别
const zipped = zipSync(filesToZip, {
  level: 3,  // 从 6 改为 3
});
```

## 📋 测试清单

- [ ] 配置 CPU 限制到 150000ms
- [ ] 修改压缩级别为 3
- [ ] 测试 1GB 文件上传和压缩
- [ ] 测试 5GB 文件上传和压缩
- [ ] 测试 10GB 文件上传和压缩
- [ ] 监控实际 CPU 使用时间
- [ ] 测试错误处理（超时场景）
- [ ] 压力测试（并发上传）

## 🚀 部署后监控

部署到生产环境后，建议监控：

1. **平均压缩时间**
2. **CPU 超时错误率**
3. **内存使用峰值**
4. **用户上传文件大小分布**

根据实际数据调整配置。

---

**生成日期**: 2025-11-11
**测试工具**: `test-compression.js`
**库版本**: fflate ^0.8.2
